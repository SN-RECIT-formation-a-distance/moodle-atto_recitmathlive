YUI.add("moodle-atto_recitmathlive-button",function(l,t){l.namespace("M.atto_recitmathlive").Button=l.Base.create("button",l.M.editor_atto.EditorPlugin,[],{TEMPLATE:'<div style="margin-bottom:20px;height:300px;overflow-y:auto" id="{{component}}inputblock"></div><div style="text-align:right"><button id="{{component}}close" class="btn btn-secondary">{{get_string "close" component}}</button><button class="btn btn-primary" id="{{component}}submit"> {{get_string "save" component}}</button></div>',COMPONENTNAME:"atto_recitmathlive",_currentSelection:null,_content:null,stream:null,math:null,initializer:function(){var e,t;this.get("host").canShowFilepicker("media")&&(this.addButton({title:"pluginname",icon:"e/math",iconComponent:this.COMPONENTNAME,callback:this.open,buttonName:"recitmathlive"}),t=M.cfg.wwwroot+"/lib/editor/atto/plugins/recitmathlive/js/",e=this,requirejs([t+"mathlive.min.js"],function(t){window.MathLive=t;t=e.get("host").textarea.ancestor("form");t&&t.on("submit",e.submitAtto,e),setTimeout(e.renderMath.bind(e),500)}),M.filter_mathjaxloader&&window.MathJax?M.filter_mathjaxloader.typeset():document.getElementById("recitmathjax")||(window.MathJax={jax:["input/TeX","output/SVG"],extensions:["tex2jax.js","MathMenu.js","MathZoom.js"],showMathMenu:!1,showProcessingMessages:!1,messageStyle:"none",SVG:{useGlobalCache:!1},TeX:{extensions:["AMSmath.js","AMSsymbols.js","autoload-all.js"]}},(t=document.createElement("script")).setAttribute("src","https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/latest.js"),t.setAttribute("id","recitmathjax"),t.setAttribute("type","text/javascript"),document.getElementsByTagName("head")[0].appendChild(t)))},getSelectedNode:function(){var t=document.getSelection().anchorNode;return t?3==t.nodeType?t.parentNode:t:null},open:function(){var t,o,e,i,s,r,n,a;if(this.dialogue=this.getDialogue({headerContent:M.util.get_string("pluginname",this.COMPONENTNAME),focusAfterHide:!0,width:"auto",height:"auto"}),(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i))&&window.scrollTo(0,1),i="f(x)=",this.selectedNode||(e=this.getSelectedNode(),(e=this.getParentFromClass(e,this.COMPONENTNAME+"block"))&&e.classList.contains(this.COMPONENTNAME+"block")&&(this.selectedNode=e)),t=[],this.selectedNode&&(t=this.selectedNode.querySelectorAll("."+this.COMPONENTNAME)),e=l.Handlebars.compile(this.TEMPLATE),i=l.Node.create(e({elementid:this.get("host").get("elementid"),component:this.COMPONENTNAME,width:.8*window.innerWidth,height:.8*window.innerHeight})),this.dialogue.set("bodyContent",i).show(),o=document.getElementById(this.COMPONENTNAME+"inputblock"),e=document.getElementById(this.COMPONENTNAME+"close"),i=document.getElementById(this.COMPONENTNAME+"submit"),r=(s=this).get("host"),this.plus=document.createElement("a"),this.plus.innerHTML="<i class='fa fa-plus'></i><br>",this.plus.href="#",this.plus.style.color="#000",this.plus.addEventListener("click",()=>{this.createField("",!0)}),o.append(this.plus),0==t.length)s.createField("f(x)=",!1);else for(n of t)a=n.getAttribute("data-latex"),s.createField(a,!0);e.addEventListener("click",function(t){t.preventDefault(),s.close()}),i.addEventListener("click",function(t){var e,i,n,a;t.preventDefault(),e="";for(i of o.getElementsByTagName("math-field"))0<(n=i.getValue("latex")).trim().length&&(a=s.formatForMathJaxFilter(n),e=e+"<span class='"+s.COMPONENTNAME+"block'><span class='"+s.COMPONENTNAME+"' data-latex='"+n+"'>"+a+"</span><br></span>");r.focus(),r.restoreSelection(),s.selectedNode?s.selectedNode.innerHTML=e:r.insertContentAtFocusPoint(e),s.close(),setTimeout(function(){s.renderMath(),s.markUpdated()},500)},!1),o.addEventListener("keypress",function(t){"Enter"===t.key&&s.createField("",!0)})},createField(t,e,i){var n,a,o=document.createElement("div");e&&((n=document.createElement("a")).innerHTML="<i class='fa fa-plus'></i><br>",n.href="#",n.style.color="#000",n.addEventListener("click",()=>{this.createField("",!0,o)}),o.append(n)),document.getElementById(this.COMPONENTNAME+"inputblock"),(a=document.createElement("math-field")).classList.add("d-inline-block"),a.style.minWidth="300px",a.setAttribute("virtual-keyboard-mode","onfocus"),a.innerText=t,o.append(a),e&&((n=document.createElement("a")).innerHTML="<i class='fa fa-times'></i>",n.href="#",n.style.color="#ff0000",n.addEventListener("click",()=>{a.remove(),n.remove()}),o.append(n)),(i||this.plus).before(o),a.focus()},submitAtto(){this.unrenderMath(),this.markUpdated()},formatForMathJaxFilter(t){return"\\("+(t=t.replace(" ","\\ "))+"\\)"},doubleClickHandler(t){var e=this.getParentFromClass(t.target,this.COMPONENTNAME+"block");e&&(this.selectedNode=e,t.stopPropagation(),this.open())},getParentFromClass(t,e){if(!t)return!1;if(t.classList.contains(e))return t;for(;t=t.parentElement;)if(t.classList.contains(e))return t;return!1},tex2img(t,n,a){MathJax.Hub.Queue(function(){var i=MathJax.HTML.Element("span",{},t);MathJax.Hub.Typeset(i,function(){var e,t=i.getElementsByTagName("svg")[0];t?(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),(e=new Image).src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(t.outerHTML))),e.onload=function(){var t=document.createElement("canvas");t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t='<img src="'+t.toDataURL("image/png")+'"/>',n(t,a)}):n(i.innerHTML,a)})})},renderMath(){var t,e,i=this.get("host").editor.getDOMNode(),i=i.querySelectorAll("."+this.COMPONENTNAME);for(t of i)e=t.getAttribute("data-latex"),t.onclick=this.doubleClickHandler.bind(this),e=this.formatForMathJaxFilter(e),this.tex2img(e,(t,e)=>{e.innerHTML=t,e.setAttribute("contenteditable","false")},t)},unrenderMath(){var t,e,i=this.get("host").editor.getDOMNode(),i=i.querySelectorAll("."+this.COMPONENTNAME);for(t of i)e=t.getAttribute("data-latex"),t.innerHTML=this.formatForMathJaxFilter(e)},close:function(){this.getDialogue({focusAfterHide:null}).hide(),this.selectedNode=null}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]}
);