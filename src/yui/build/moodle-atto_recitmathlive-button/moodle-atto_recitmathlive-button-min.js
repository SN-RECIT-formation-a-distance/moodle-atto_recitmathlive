YUI.add("moodle-atto_recitmathlive-button",function(a,t){a.namespace("M.atto_recitmathlive").Button=a.Base.create("button",a.M.editor_atto.EditorPlugin,[],{TEMPLATE:'<div style="margin-bottom:20px"><math-field id="{{component}}input" virtual-keyboard-mode="onfocus">{{content}}</math-field></div><button id="{{component}}close" class="btn btn-secondary">{{get_string "close" component}}</button><button class="btn btn-secondary" id="{{component}}submit"> {{get_string "save" component}}</button></div>',COMPONENTNAME:"atto_recitmathlive",_currentSelection:null,_content:null,stream:null,math:null,initializer:function(){var t,e;this.get("host").canShowFilepicker("media")&&(this.addButton({title:"pluginname",icon:"e/math",iconComponent:this.COMPONENTNAME,callback:this.open,buttonName:"recitmathlive"}),t=M.cfg.wwwroot+"/lib/editor/atto/plugins/recitmathlive/js/mathlive.min.js",e=this,requirejs([t],function(t){window.MathLive=t;t=e.get("host").textarea.ancestor("form");t&&t.on("submit",e.submitAtto,e),setTimeout(function(){e.renderMath()},600)}))},getSelectedNode:function(){var t=document.getSelection().anchorNode;return 3==t.nodeType?t.parentNode:t},open:function(){var n,t,e,i,o;this.dialogue=this.getDialogue({headerContent:M.util.get_string("pluginname",this.COMPONENTNAME),focusAfterHide:!0,width:"auto",height:"auto"}),(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i))&&window.scrollTo(0,1),e="f(x)=",t=this.getSelectedNode(),(t=this.getParentFromClass(t,this.COMPONENTNAME))&&t.classList.contains(this.COMPONENTNAME)&&(e=(this.selectedNode=t).getAttribute("data-latex")),t=a.Handlebars.compile(this.TEMPLATE),e=a.Node.create(t({elementid:this.get("host").get("elementid"),component:this.COMPONENTNAME,content:e,width:.8*window.innerWidth,height:.8*window.innerHeight})),this.dialogue.set("bodyContent",e).show(),n=document.getElementById(this.COMPONENTNAME+"input"),t=document.getElementById(this.COMPONENTNAME+"close"),e=document.getElementById(this.COMPONENTNAME+"submit"),o=(i=this).get("host"),t.addEventListener("click",function(t){t.preventDefault(),i.close()}),e.addEventListener("click",function(t){var e;t.preventDefault(),e=n.getValue("latex"),t=i.formatForMathJaxFilter(e),o.focus(),o.restoreSelection(),i.selectedNode?(i.selectedNode.innerHTML=t,i.selectedNode.setAttribute("data-latex",e)):o.insertContentAtFocusPoint("<span class='"+i.COMPONENTNAME+"' data-latex='"+e+"'>"+t+"</span>"),i.close(),setTimeout(function(){i.renderMath(),i.markUpdated()},500)},!1)},submitAtto(){this.unrenderMath(),this.markUpdated()},formatForMathJaxFilter(t){return"\\("+(t=t.replace(" ","\\ "))+"\\)"},doubleClickHandler(t){this.getParentFromClass(t.target,this.COMPONENTNAME)&&(t.stopPropagation(),this.open())},getParentFromClass(t,e){if(t.classList.contains(e))return t;for(;t=t.parentElement;)if(t.classList.contains(e))return t;return!1},renderMath(){var t,e=this.get("host").editor.getDOMNode();MathLive.renderMathInElement(e);for(t of e.querySelectorAll("."+this.COMPONENTNAME))t.ondblclick=this.doubleClickHandler.bind(this)},unrenderMath(){var t,e,n=this.get("host").editor.getDOMNode(),n=n.querySelectorAll("."+this.COMPONENTNAME);for(t of n)e=t.getAttribute("data-latex"),t.innerHTML=this.formatForMathJaxFilter(e)},close:function(){this.getDialogue({focusAfterHide:null}).hide(),this.selectedNode=null}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});